<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轉型正義最高司法機關決定系統</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 引入靜態資料庫 -->
    <script src="data.js"></script> 
    <style>
        body { font-family: "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif; }
        .sidebar-scroll { height: calc(100vh - 110px); }
        .bar-label { width: 140px; font-size: 0.85rem; color: #4b5563; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; }
        .bar-fill { height: 16px; border-radius: 4px; transition: width 0.5s ease; cursor: pointer; }
        .bar-fill:hover { opacity: 0.8; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(90deg); }
        .arrow { transition: transform 0.2s ease; }

        .sidebar-mobile { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helpers & Components ---

        // 改進後的角色解析組件
        const PrefaceCard = ({ text }) => {
            if (!text) return null;

            const roles = [
                "上訴人", "被上訴人", "原告", "被告", "聲請人", "相對人", 
                "再審原告", "再審被告", "抗告人", "代表人", "訴訟代理人", 
                "辯護人", "參加人", "輔佐人"
            ];

            // 1. 尋找分界線 (當事人列表結束的地方)
            const boundaries = ["右當事人間", "上列當事人間", "當事人間", "上列聲請人", "因.*事件", "對本院", "不服.*決定"];
            let content = text.replace(/^前置\s*/, '');
            
            let splitIndex = -1;
            for (const b of boundaries) {
                const re = new RegExp(b);
                const match = content.match(re);
                if (match) {
                    if (splitIndex === -1 || match.index < splitIndex) {
                        splitIndex = match.index;
                    }
                }
            }

            // 拆分為「當事人區」與「敘述區」
            let partyText = splitIndex !== -1 ? content.substring(0, splitIndex) : content;
            let narrativeText = splitIndex !== -1 ? content.substring(splitIndex) : "";

            // 2. 解析當事人
            const rolePattern = new RegExp(`(${roles.join('|')})`, 'g');
            const parts = partyText.split(rolePattern);
            const parties = [];
            for (let i = 1; i < parts.length; i += 2) {
                const role = parts[i];
                let name = parts[i+1] ? parts[i+1].trim() : "";
                name = name.replace(/[，。；：\s]+$/, '').replace(/^[，。；：\s]+/, '');
                if (role && name) parties.push({ role, name });
            }

            return (
                <div class="space-y-4 mb-8">
                    {/* 當事人卡片 */}
                    {parties.length > 0 && (
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                                    <i class="fas fa-users mr-2"></i>訴訟當事人
                                </span>
                            </div>
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">
                                {parties.map((p, idx) => (
                                    <div key={idx} class="flex items-center group">
                                        <span class={`
                                            shrink-0 px-2 py-1 rounded text-[10px] font-black mr-3 w-20 text-center uppercase
                                            ${['原告', '上訴人', '聲請人', '再審原告', '抗告人'].includes(p.role) ? 'bg-blue-600 text-white' : ''}
                                            ${['被告', '被上訴人', '相對人', '再審被告'].includes(p.role) ? 'bg-rose-600 text-white' : ''}
                                            ${['代表人', '訴訟代理人', '辯護人'].includes(p.role) ? 'bg-slate-200 text-slate-600' : 'bg-slate-100 text-slate-500'}
                                        `}>
                                            {p.role}
                                        </span>
                                        <span class="text-sm text-slate-700 font-bold group-hover:text-blue-600 transition-colors">
                                            {p.name}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* 背景敘述 (引言格式) */}
                    {narrativeText && (
                        <div class="relative pl-6 py-2">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-slate-200 rounded-full"></div>
                            <p class="text-sm text-slate-500 italic leading-relaxed">
                                {narrativeText.trim()}
                            </p>
                        </div>
                    )}

                    {/* 如果什麼都解析不出來的分回退機制 */}
                    {parties.length === 0 && !narrativeText && (
                        <div class="bg-slate-50 p-4 rounded-lg border border-dashed border-slate-300 text-gray-400 text-sm italic text-center">
                            無結構化前置資訊
                        </div>
                    )}
                </div>
            );
        };

        const HighlightedText = ({ text, term }) => {
            if (!text) return null;
            if (!term) return <>{text}</>;

            try {
                // Escape regex special characters in term
                const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                const parts = text.split(regex);

                return (
                    <>
                        {parts.map((part, i) => 
                            regex.test(part) ? (
                                <span key={i} class="bg-yellow-300 text-slate-900 font-bold px-0.5 rounded box-decoration-clone">
                                    {part}
                                </span>
                            ) : (
                                <React.Fragment key={i}>{part}</React.Fragment>
                            )
                        )}
                    </>
                );
            } catch (e) {
                console.error("Highlight error", e);
                return <>{text}</>;
            }
        };

        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div class="fixed inset-0 z-[60] flex items-center justify-center modal-overlay p-4" onClick={onClose}>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div class="p-5 border-b bg-slate-900 text-white flex justify-between items-center">
                            <h3 class="font-bold text-lg"><i class="fas fa-book-reader mr-2"></i>系統操作說明</h3>
                            <button onClick={onClose} class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <section>
                                <h4 class="text-blue-600 font-bold border-b pb-2 mb-3">資料視覺化</h4>
                                <p class="text-sm text-gray-600 leading-relaxed">儀表板展示了轉型正義案件在各法院的決定傾向。您可以點擊任何統計圖表來調閱相關的案號清單。</p>
                            </section>
                            <section>
                                <h4 class="text-blue-600 font-bold border-b pb-2 mb-3">法條智慧標示</h4>
                                <p class="text-sm text-gray-600 leading-relaxed">在閱讀判決時，點擊底部的法條標籤，系統會自動在內文中標示出該法條出現的所有段落。</p>
                            </section>
                        </div>
                        <div class="p-4 bg-gray-50 border-t text-right">
                            <button onClick={onClose} class="bg-blue-600 text-white px-6 py-2 rounded font-bold">關閉</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, items, onSelectCase }) => {
            if (!isOpen) return null;
            return (
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4" onClick={onClose}>
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-lg">
                            <h3 class="font-bold text-lg text-slate-800">{title}</h3>
                            <button onClick={onClose} class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <div class="space-y-2">
                                {items.map((item, idx) => (
                                    <button key={idx} onClick={() => onSelectCase(item.analysis_meta.path)} class="w-full text-left p-3 rounded border hover:bg-blue-50 hover:border-blue-300 transition-colors group">
                                        <div class="flex justify-between items-start">
                                            <span class="font-bold text-blue-700 text-sm group-hover:underline">{item.meta.title}</span>
                                            <span class="text-xs text-gray-400">{item.meta.date_minguo}</span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1 truncate">{item.main_text_clean}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data, colorClass = "bg-blue-500", onBarClick }) => {
            if (!data || data.length === 0) return <div class="text-xs text-gray-400 italic">無數據</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div class="space-y-1.5">
                    {data.map((item, idx) => (
                        <div key={idx} class="flex items-center text-sm group cursor-pointer" onClick={() => onBarClick(item.label)}>
                            <div class="bar-label mr-2 text-right group-hover:text-blue-600" title={item.label}>{item.label}</div>
                            <div class="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                                <div class={`bar-fill ${colorClass}`} style={{ width: `${(item.value / maxVal) * 100}%` }}></div>
                            </div>
                            <div class="w-12 text-right text-xs text-gray-500 ml-2 group-hover:font-bold">{item.value}</div>
                        </div>
                    ))}
                </div>
            );
        };

        const ExportModal = ({ isOpen, onClose, onExport }) => {
            const [mode, setMode] = useState('list');
            if (!isOpen) return null;
            return (
                <div class="fixed inset-0 z-[70] flex items-center justify-center modal-overlay p-4" onClick={onClose}>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div class="p-5 border-b bg-slate-800 text-white flex justify-between items-center">
                            <h3 class="font-bold text-lg"><i class="fas fa-file-excel mr-2 text-green-400"></i>匯出 Excel 報表</h3>
                            <button onClick={onClose} class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-6 space-y-4">
                            <p class="text-sm text-gray-500">請選擇匯出的資料範圍：</p>
                            <div class="space-y-2">
                                {[
                                    { id: 'list', label: '基本列表 (案號、標題、結果)', icon: 'fa-list' },
                                    { id: 'summary', label: '包含 AI 摘要 (AI 重點摘要內容)', icon: 'fa-robot' },
                                    { id: 'full', label: '包含判決全文 (完整理由段落)', icon: 'fa-file-alt' }
                                ].map(opt => (
                                    <label key={opt.id} class={`flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all ${mode === opt.id ? 'border-blue-600 bg-blue-50' : 'border-gray-100 hover:border-gray-200'}`}>
                                        <input type="radio" name="exportMode" class="hidden" checked={mode === opt.id} onChange={() => setMode(opt.id)} />
                                        <i class={`fas ${opt.icon} mr-3 w-6 text-center ${mode === opt.id ? 'text-blue-600' : 'text-gray-400'}`}></i>
                                        <span class={`text-sm font-bold ${mode === opt.id ? 'text-blue-900' : 'text-gray-600'}`}>{opt.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 border-t flex space-x-3">
                            <button onClick={onClose} class="flex-1 px-4 py-2 border border-gray-300 rounded font-bold text-gray-600 hover:bg-gray-100">取消</button>
                            <button onClick={() => onExport(mode)} class="flex-1 px-4 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 shadow-md">開始匯出</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ db, onSelectCase }) => {
            const [activeCategory, setActiveCategory] = useState(null);
            const [modalState, setModalState] = useState({ isOpen: false, title: '', items: [] });
            const [isExportModalOpen, setExportModalOpen] = useState(false);

            const stats = useMemo(() => {
                const overview = { totalCases: db.length, totalCourts: new Set(db.map(m => m.analysis_meta.court_normalized)).size, categories: {} };
                const details = {};
                db.forEach(item => {
                    const cat = item.analysis_meta.category_normalized;
                    const court = item.analysis_meta.court_normalized;
                    if (!overview.categories[cat]) overview.categories[cat] = 0;
                    overview.categories[cat]++;
                    if (!details[cat]) details[cat] = {};
                    if (!details[cat][court]) details[cat][court] = { total: 0, decisions: {}, mainTexts: {}, items: [] };
                    details[cat][court].total++;
                    details[cat][court].items.push(item);
                    const dType = item.decision_result || '其他';
                    details[cat][court].decisions[dType] = (details[cat][court].decisions[dType] || 0) + 1;
                    const mText = item.main_text_clean || '(無主文)';
                    details[cat][court].mainTexts[mText] = (details[cat][court].mainTexts[mText] || 0) + 1;
                });
                return { overview, details };
            }, [db]);

            const handleChartClick = (court, type, label) => {
                const categoryData = stats.details[activeCategory][court];
                let filteredItems = [];
                if (type === 'decision') filteredItems = categoryData.items.filter(m => (m.decision_result || '其他') === label);
                else if (type === 'mainText') filteredItems = categoryData.items.filter(m => (m.main_text_clean || '(無主文)') === label);
                setModalState({ isOpen: true, title: `${court} - ${label}`, items: filteredItems });
            };

            const handleExport = (mode) => {
                const wb = XLSX.utils.book_new();
                
                // Group by category
                const groups = {};
                db.forEach(item => {
                    const cat = item.analysis_meta.category_normalized || '未分類';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });

                // Sort categories by passage date
                const catWeights = {
                    '戒嚴時期人民受損權利回復條例': 1,
                    '二二八事件處理及補償條例': 2,
                    '戒嚴時期不當叛亂暨匪諜審判案件補償條例': 3,
                    '政黨及其附隨組織不當取得財產處理條例': 4,
                    '促進轉型正義條例': 5,
                    '威權統治時期國家不法行為被害者權利回復條例': 6
                };

                const sortedCats = Object.keys(groups).sort((a, b) => {
                    const wa = catWeights[a] || 99;
                    const wb_val = catWeights[b] || 99;
                    return wa - wb_val;
                });

                // --- 1. Category Sheets with Stats ---
                sortedCats.forEach(cat => {
                    // A. Prepare Data Rows
                    const rows = groups[cat].map(item => {
                        const courtName = item.analysis_meta.court_normalized || item.meta.court || '其他';
                        const base = {
                            '案號': item.meta.id,
                            '標題': item.meta.title,
                            '法院': courtName,
                            '判決日期': item.meta.date_minguo,
                            '案由': item.meta.cause,
                            '判決結果': item.decision_result,
                            '原始連結': item.meta.source_url, // Added URL
                            '主文': item.main_text_clean
                        };

                        if (mode === 'summary') {
                            base['AI 摘要'] = item.ai_summary ? item.ai_summary.map((s, i) => `${i+1}. ${s.point}`).join('\n') : '';
                        } else if (mode === 'full') {
                            base['全文內容'] = item.sections ? Object.entries(item.sections).map(([k, v]) => `【${k}】\n${v}`).join('\n\n') : '';
                        }
                        return base;
                    });

                    const ws = XLSX.utils.json_to_sheet(rows);

                    // B. Calculate & Append Court Statistics
                    const courtStats = {};
                    groups[cat].forEach(item => {
                        const c = item.analysis_meta.court_normalized || item.meta.court || '其他';
                        courtStats[c] = (courtStats[c] || 0) + 1;
                    });
                    
                    // Convert stats to rows for appending
                    // We map them to the first few columns to keep structure valid
                    const statRows = [
                        {}, // Empty row for spacing
                        { '案號': '【法院案件量統計】' }, // Header
                        ...Object.entries(courtStats)
                           .sort((a, b) => b[1] - a[1])
                           .map(([court, count]) => ({
                               '案號': court,
                               '標題': `${count} 件`
                           }))
                    ];

                    XLSX.utils.sheet_add_json(ws, statRows, { skipHeader: true, origin: -1 });

                    // C. Formatting
                    ws['!cols'] = [
                        { wch: 25 }, // 案號
                        { wch: 35 }, // 標題
                        { wch: 15 }, // 法院
                        { wch: 20 }, // 判決日期
                        { wch: 20 }, // 案由
                        { wch: 15 }, // 判決結果
                        { wch: 50 }, // 原始連結
                        { wch: 40 }  // 主文
                    ];
                    if (mode === 'summary') ws['!cols'].push({ wch: 80 });
                    if (mode === 'full') ws['!cols'].push({ wch: 100 });

                    XLSX.utils.book_append_sheet(wb, ws, cat.substring(0, 31));
                });

                // --- 2. New Decadal Trends Sheet ---
                const decadalStats = {}; // { "1990s": { "LawA": 10, "LawB": 5 } }
                
                db.forEach(item => {
                    const date = item.meta.date_iso; // "YYYY-MM-DD"
                    if (!date) return;
                    
                    const year = parseInt(date.split('-')[0]);
                    if (isNaN(year)) return;
                    
                    const decade = Math.floor(year / 10) * 10;
                    const decadeLabel = `${decade}年代`;
                    const cat = item.analysis_meta.category_normalized || '未分類';

                    if (!decadalStats[decadeLabel]) decadalStats[decadeLabel] = {};
                    if (!decadalStats[decadeLabel][cat]) decadalStats[decadeLabel][cat] = 0;
                    decadalStats[decadeLabel][cat]++;
                });

                // Flatten for SheetJS
                const trendRows = Object.keys(decadalStats).sort().map(decade => {
                    const row = { '年代區間': decade };
                    let total = 0;
                    sortedCats.forEach(cat => {
                        const count = decadalStats[decade][cat] || 0;
                        row[cat] = count;
                        total += count;
                    });
                    row['區間總計'] = total;
                    return row;
                });

                const wsTrends = XLSX.utils.json_to_sheet(trendRows);
                
                // Set trend column widths
                const trendCols = [{ wch: 15 }]; // Date column
                sortedCats.forEach(() => trendCols.push({ wch: 20 })); // Category columns
                trendCols.push({ wch: 10 }); // Total
                wsTrends['!cols'] = trendCols;

                XLSX.utils.book_append_sheet(wb, wsTrends, "年代趨勢統計");

                XLSX.writeFile(wb, `轉型正義判決匯出_${new Date().toISOString().split('T')[0]}.xlsx`);
                setExportModalOpen(false);
            };

            return (
                <div class="p-4 md:p-6 max-w-7xl mx-auto">
                    <Modal isOpen={modalState.isOpen} onClose={() => setModalState({ ...modalState, isOpen: false })} title={modalState.title} items={modalState.items} onSelectCase={(path) => { setModalState({ ...modalState, isOpen: false }); onSelectCase(path); }} />
                    <ExportModal isOpen={isExportModalOpen} onClose={() => setExportModalOpen(false)} onExport={handleExport} />
                    
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800"><i class="fas fa-chart-pie mr-3 text-blue-600"></i>數據儀表板</h2>
                        <div class="flex space-x-2 mt-4 md:mt-0">
                            <button 
                                onClick={() => setExportModalOpen(true)}
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm transition-all flex items-center"
                            >
                                <i class="fas fa-file-excel mr-2"></i> 匯出 Excel
                            </button>
                            {activeCategory && <button onClick={() => setActiveCategory(null)} class="text-sm bg-gray-200 px-3 py-2 rounded text-slate-600"><i class="fas fa-arrow-left mr-1"></i> 返回總覽</button>}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-8 pb-2 border-b">
                        <button onClick={() => setActiveCategory(null)} class={`px-4 py-2 rounded-lg font-bold text-sm transition-colors ${!activeCategory ? 'bg-slate-800 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}`}>總覽</button>
                        {Object.keys(stats.details || {}).map(cat => (
                            <button key={cat} onClick={() => setActiveCategory(cat)} class={`px-4 py-2 rounded-lg font-bold text-sm transition-colors ${activeCategory === cat ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}`}>{cat}</button>
                        ))}
                    </div>
                    {!activeCategory ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {Object.entries(stats.overview?.categories || {}).map(([cat, count]) => (
                                <div key={cat} onClick={() => setActiveCategory(cat)} class="bg-white rounded-xl p-6 shadow-sm border hover:shadow-md cursor-pointer group">
                                    <div class="text-gray-400 text-[10px] font-black uppercase tracking-widest mb-2 group-hover:text-blue-600">{cat}</div>
                                    <div class="text-3xl font-bold text-slate-800">{count} <span class="text-xs font-normal text-gray-400">件判決</span></div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {Object.entries(stats.details[activeCategory]).map(([court, data]) => (
                                <div key={court} class="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <div class="bg-slate-50 px-5 py-3 border-b flex justify-between items-center">
                                        <h3 class="font-bold text-slate-800">{court}</h3>
                                        <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-black">{data.total} CASES</span>
                                    </div>
                                    <div class="p-5 space-y-8">
                                        <div>
                                            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 pb-1 border-b">結果分佈</h4>
                                            <SimpleBarChart data={Object.entries(data.decisions).map(([k,v]) => ({label: k, value: v})).sort((a,b) => b.value - a.value)} colorClass="bg-rose-500" onBarClick={(label) => handleChartClick(court, 'decision', label)} />
                                        </div>
                                        <div>
                                            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 pb-1 border-b">常見主文分析</h4>
                                            <ul class="space-y-1">
                                                {Object.entries(data.mainTexts).sort((a,b) => b[1] - a[1]).slice(0, 5).map(([text, count], idx) => (
                                                    <li key={idx} onClick={() => handleChartClick(court, 'mainText', text)} class="text-xs text-gray-600 flex justify-between items-center bg-slate-50 hover:bg-blue-50 p-2 rounded cursor-pointer transition-colors">
                                                        <span class="mr-2 flex-1 font-mono truncate">{text}</span>
                                                        <span class="font-bold text-gray-300">{count}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const GEMINI_API_KEY = "AIzaSyCZaSb7T-jBnVKrlhvSiGpTks_HI4gLtI0"; // ⚠️ SECURITY WARNING: Exposing API keys in client-side code is insecure for public websites. Use with caution or backend proxy.

        const GeminiSummary = ({ text, onClickRef, savedSummary }) => {
            const [loading, setLoading] = useState(false);
            const [summary, setSummary] = useState(savedSummary || null);
            const [error, setError] = useState(null);

            // Sync with prop if it changes (e.g. data reload)
            useEffect(() => {
                if (savedSummary) setSummary(savedSummary);
            }, [savedSummary]);

            const handleSummarize = async () => {
                setLoading(true);
                setError(null);
                
                // Pre-process text to paragraphs for the prompt
                const paragraphs = text.split('\n').filter(p => p.trim());
                const numberedText = paragraphs.map((p, i) => `[${i}] ${p}`).join('\n');

                const prompt = `你是一個專業的法律助理。請根據以下法院判決的「理由」部分，生成一份重點摘要。
請遵循以下規則：
1. 用列點方式說明判決的關鍵爭點、法院的判斷理由、以及最終結論。
2. 對於每一個摘要點，**必須**具體引用支持該論點的段落編號，格式為 [ref:段落編號]。
3. 回傳格式必須為單純的 JSON 陣列，不要有 markdown 標記。格式範例：
[
    { "point": "原告主張...", "refs": [0, 2] },
    { "point": "法院認為...", "refs": [5] }
]

判決文本如下：
${numberedText}`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let rawText = data.candidates[0].content.parts[0].text;
                    // Clean up markdown code blocks if present
                    rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const parsed = JSON.parse(rawText);
                    setSummary(parsed);
                } catch (err) {
                    console.error(err);
                    setError("摘要生成失敗，請稍後再試。");
                } finally {
                    setLoading(false);
                }
            };

            if (!summary && !loading) {
                return (
                    <div class="mb-8">
                        <button onClick={handleSummarize} class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-magic mr-2"></i> AI 判決摘要
                        </button>
                    </div>
                );
            }

            return (
                <div class="mb-8 bg-indigo-50 rounded-xl p-6 border border-indigo-100 shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-indigo-900 flex items-center">
                            <i class="fas fa-robot mr-2 text-indigo-600"></i>
                            Gemini 智慧摘要
                        </h3>
                        {loading && <span class="text-indigo-500 text-sm animate-pulse"><i class="fas fa-spinner fa-spin mr-2"></i>分析中...</span>}
                        {savedSummary && <span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded">已存檔</span>}
                    </div>
                    
                    {error && <div class="text-red-500 text-sm">{error}</div>}
                    
                    {summary && (
                        <ul class="space-y-4">
                            {summary.map((item, idx) => (
                                <li key={idx} class="flex items-start">
                                    <span class="bg-indigo-200 text-indigo-800 text-xs font-bold px-2 py-0.5 rounded-full mr-3 mt-1 shrink-0">{idx + 1}</span>
                                    <div>
                                        <p class="text-slate-800 text-sm leading-relaxed font-medium">
                                            {item.point}
                                            {item.refs && item.refs.map(ref => (
                                                <button 
                                                    key={ref}
                                                    onClick={() => onClickRef(ref)}
                                                    class="ml-2 inline-flex items-center text-[10px] bg-white border border-indigo-200 text-indigo-600 px-1.5 py-0.5 rounded cursor-pointer hover:bg-indigo-600 hover:text-white transition-colors"
                                                >
                                                    <i class="fas fa-quote-right mr-1"></i>段落 {ref + 1}
                                                </button>
                                            ))}
                                        </p>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const ParagraphReader = ({ text, highlightTerm, sectionTitle, savedSummary }) => {
            // Split by newlines but keep track of indices
            // If sectionTitle is NOT '理由', we might just render normally to avoid clutter?
            // User specifically asked for this feature, likely for the main reasoning.
            
            const paragraphs = useMemo(() => {
                return text.split('\n').map((p, i) => ({ id: i, content: p }));
            }, [text]);

            // Only enable AI features for '理由' section
            const enableAI = sectionTitle.includes('理由');

            return (
                <div class="relative">
                    {enableAI && (
                        <GeminiSummary 
                            text={text} 
                            savedSummary={savedSummary}
                            onClickRef={(id) => {
                                const el = document.getElementById(`p-${sectionTitle}-${id}`);
                                if (el) {
                                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    el.classList.add('bg-yellow-100');
                                    setTimeout(() => el.classList.remove('bg-yellow-100'), 2000);
                                }
                            }} 
                        />
                    )}
                    
                    <div class="space-y-4">
                        {paragraphs.map((p) => (
                            <div 
                                id={`p-${sectionTitle}-${p.id}`} 
                                key={p.id} 
                                class={`transition-colors duration-1000 p-1 rounded ${!p.content.trim() ? 'h-4' : ''}`}
                            >
                                <div class="text-slate-700 whitespace-pre-wrap leading-[2] text-justify text-base md:text-lg tracking-wide font-medium relative group">
                                    {enableAI && p.content.trim() && (
                                        <span class="absolute -left-8 top-1 text-xs text-gray-300 select-none group-hover:text-blue-400 font-mono">
                                            {p.id + 1}
                                        </span>
                                    )}
                                    <HighlightedText text={p.content} term={highlightTerm} />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const db = window.JUDGMENT_DB || [];
            const [view, setView] = useState('dashboard');
            const [selectedPath, setSelectedPath] = useState(null);
            const [judgment, setJudgment] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [highlightTerm, setHighlightTerm] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [showLaws, setShowLaws] = useState(true);

            useEffect(() => {
                if(selectedPath) {
                    setView('reader');
                    setHighlightTerm(null);
                    const found = db.find(x => x.analysis_meta.path === selectedPath);
                    setJudgment(found);
                    setSidebarOpen(false);
                }
            }, [selectedPath, db]);

            const sidebarData = useMemo(() => {
                const grouped = {};
                db.forEach(item => {
                    const name = item.meta.title;
                    if (searchTerm && !name.includes(searchTerm)) return;
                    const cat = item.analysis_meta.category_normalized;
                    const jType = item.analysis_meta.judgment_type_normalized || '其他';
                    const dResult = item.decision_result || '其他';
                    if (!grouped[cat]) grouped[cat] = {};
                    if (!grouped[cat][jType]) grouped[cat][jType] = {};
                    if (!grouped[cat][jType][dResult]) grouped[cat][jType][dResult] = [];
                    grouped[cat][jType][dResult].push(item);
                });
                return grouped;
            }, [db, searchTerm]);

            if (db.length === 0) return <div class="flex items-center justify-center h-screen">載入中...</div>;

            return (
                <div class="flex h-screen overflow-hidden flex-col md:flex-row">
                    <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
                    <div class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center z-50 shadow-md">
                        <div class="font-bold truncate"><i class="fas fa-scale-balanced text-yellow-500 mr-2"></i>轉型正義系統</div>
                        <div class="flex items-center space-x-3">
                            <button onClick={() => setShowHelp(true)}><i class="fas fa-question-circle"></i></button>
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)}><i class={`fas ${isSidebarOpen ? 'fa-times' : 'fa-bars'}`}></i></button>
                        </div>
                    </div>
                    <div class={`fixed inset-0 z-40 bg-slate-900 text-gray-300 flex flex-col transition-transform md:translate-x-0 md:relative md:w-80 md:flex ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div class="p-4 bg-slate-800 shadow z-10 hidden md:block">
                            <h1 class="font-bold text-white mb-4 flex justify-between">
                                <span onClick={() => setView('dashboard')} class="cursor-pointer">轉型正義決定系統</span>
                                <button onClick={() => setShowHelp(true)} class="text-gray-500"><i class="fas fa-question-circle"></i></button>
                            </h1>
                            <div class="flex bg-slate-700 rounded p-1 mb-4">
                                <button onClick={()=>setView('dashboard')} class={`flex-1 py-1 text-xs font-bold rounded ${view==='dashboard'?'bg-blue-600 text-white':'hover:text-white'}`}>統計</button>
                                <button onClick={()=>setView('reader')} class={`flex-1 py-1 text-xs font-bold rounded ${view==='reader'?'bg-blue-600 text-white':'hover:text-white'}`}>閱讀</button>
                            </div>
                            <input type="text" placeholder="快速檢索..." class="w-full px-3 py-2 bg-slate-950 border border-slate-700 rounded text-xs text-white" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                        </div>
                        <div class="flex-1 overflow-y-auto sidebar-scroll p-2 space-y-1">
                            {Object.entries(sidebarData).map(([cat, jTypes]) => (
                                <details key={cat} class="group">
                                    <summary class="flex items-center p-2 rounded hover:bg-slate-800 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                        <i class="fas fa-chevron-right arrow mr-2 opacity-50"></i>{cat}
                                    </summary>
                                    <div class="pl-4 mt-1 space-y-1">
                                        {Object.entries(jTypes).map(([jType, dResults]) => (
                                            <details key={jType} class="group">
                                                <summary class="flex items-center p-2 rounded hover:bg-slate-800 text-[10px] font-bold text-blue-400">
                                                    <i class="fas fa-chevron-right arrow mr-2"></i>{jType}
                                                </summary>
                                                <div class="pl-4 mt-1 space-y-1">
                                                    {Object.entries(dResults).map(([dResult, items]) => (
                                                        <details key={dResult} class="group">
                                                            <summary class="flex items-center p-2 rounded hover:bg-slate-800 text-[10px] text-gray-400">
                                                                <i class="fas fa-chevron-right arrow mr-2"></i>{dResult} ({items.length})
                                                            </summary>
                                                            <div class="pl-4 mt-1 space-y-0.5 border-l border-slate-700 ml-2">
                                                                {items.map(item => (
                                                                    <button key={item.analysis_meta.path} onClick={()=>setSelectedPath(item.analysis_meta.path)} class={`w-full text-left text-[10px] px-3 py-1.5 rounded truncate transition-colors ${selectedPath === item.analysis_meta.path ? 'bg-blue-900 text-blue-200' : 'text-gray-500 hover:text-gray-300'}`}>{item.meta.title}</button>
                                                                ))}
                                                            </div>
                                                        </details>
                                                    ))}
                                                </div>
                                            </details>
                                        ))}
                                    </div>
                                </details>
                            ))}
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-gray-100 w-full relative">
                        {view === 'dashboard' ? <Dashboard db={db} onSelectCase={setSelectedPath} /> : (
                            judgment ? (
                                <div class="max-w-5xl mx-auto my-4 md:my-8 p-6 md:p-12 bg-white shadow-xl rounded-2xl min-h-[80vh]">
                                    <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-10 pb-8 border-b-2 border-slate-100">
                                        <div>
                                            <div class="flex space-x-2 mb-4">
                                                <span class="px-3 py-1 bg-slate-900 text-white text-[10px] font-black rounded uppercase tracking-widest">{judgment.meta.court}</span>
                                                <span class="px-3 py-1 bg-blue-50 text-blue-600 text-[10px] font-black rounded uppercase tracking-widest border border-blue-100">{judgment.decision_result}</span>
                                            </div>
                                            <h2 class="text-2xl md:text-3xl font-black text-slate-900 leading-tight tracking-tight">{judgment.meta.title}</h2>
                                        </div>
                                        <a href={judgment.meta.source_url} target="_blank" class="text-slate-300 hover:text-blue-600 mt-4 md:mt-0 transition-colors"><i class="fas fa-external-link-alt text-2xl"></i></a>
                                    </div>
                                    <div class="space-y-12">
                                        {judgment.sections && Object.entries(judgment.sections).map(([t, c]) => (
                                            <div key={t}>
                                                <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6 flex items-center">
                                                    <span class="w-8 h-px bg-slate-200 mr-4"></span>{t}
                                                </h3>
                                                {t === '前置' ? <PrefaceCard text={c} /> : (
                                                    <ParagraphReader 
                                                        text={c} 
                                                        highlightTerm={highlightTerm} 
                                                        sectionTitle={t} 
                                                        savedSummary={t.includes('理由') ? judgment.ai_summary : null}
                                                    />
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    {judgment.extracted_laws && judgment.extracted_laws.length > 0 && (
                                        <div class="mt-16 pt-8 border-t border-slate-200">
                                            <div class="flex justify-between items-center mb-4 cursor-pointer select-none group" onClick={() => setShowLaws(!showLaws)}>
                                                <h4 class="text-sm font-bold text-slate-700 flex items-center group-hover:text-blue-600 transition-colors">
                                                    <i class={`fas fa-chevron-${showLaws ? 'down' : 'right'} mr-2 text-slate-400 w-4 text-center`}></i>
                                                    引用法源標示
                                                    <span class="ml-2 bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded-full">{judgment.extracted_laws.length}</span>
                                                </h4>
                                                {highlightTerm && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setHighlightTerm(null); }} 
                                                        class="text-xs font-bold text-rose-500 hover:text-rose-600 hover:bg-rose-50 px-3 py-1.5 rounded transition-colors"
                                                    >
                                                        <i class="fas fa-eraser mr-1"></i>清除高亮
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {showLaws && (
                                                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100">
                                                    <div class="flex flex-wrap gap-2">
                                                        {judgment.extracted_laws.map(l => (
                                                            <button 
                                                                key={l} 
                                                                onClick={() => setHighlightTerm(l === highlightTerm ? null : l)} 
                                                                class={`px-3 py-1.5 text-xs font-medium rounded-lg border transition-all duration-200 ${highlightTerm === l ? 'bg-yellow-300 text-slate-900 border-yellow-400 ring-2 ring-yellow-200 shadow-sm transform -translate-y-0.5' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600 hover:shadow-sm'}`}
                                                            >
                                                                {l}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ) : <div class="flex flex-col items-center justify-center h-full text-slate-300"><i class="fas fa-balance-scale text-8xl mb-6 opacity-10"></i><p class="font-black uppercase tracking-widest text-sm">Select Document</p></div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>